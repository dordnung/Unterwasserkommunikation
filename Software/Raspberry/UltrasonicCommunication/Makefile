SRC = src/ultrasonic_communication.c src/ultrasonic_transmitter.c src/ultrasonic_receiver.c
TARGET = libultrasonic_communication.so

CC = gcc
STRIP = strip
CFLAGS = -Wall -Werror -fPIC -pthread -Iinclude
LDLIBS = -L. -shared -lpigpio -lm -lrt

OBJ = $(SRC:.c=.o)
DEP = $(SRC:.c=.d)

# Folders where to install library
prefix = /usr/local
includedir = $(prefix)/include
libdir = $(prefix)/lib

.PHONY: all clean

# Default target as it is the first target
# Not really required, but always good to have
all: $(TARGET)

# 1. Link the target
$(TARGET): $(OBJ) Makefile
	$(CC) $(CFLAGS) -o $@ $(OBJ) $(LDLIBS)
	$(STRIP) --strip-unneeded $@

# 2. Build the sources
%.o: %.c Makefile
	$(CC) -MMD $(CFLAGS) -c -o $@ $<

# 3. Clean autogenerated stuff
clean:
	$(RM) $(OBJ) $(DEP) $(TARGET)

# 4. Install library
install: all
	install -m 0755 -d $(DESTDIR)$(includedir)
	install -m 0644 include/ultrasonic_communication.h $(DESTDIR)$(includedir)
	install -m 0644 include/ultrasonic_transmitter.h $(DESTDIR)$(includedir)
	install -m 0644 include/ultrasonic_receiver.h $(DESTDIR)$(includedir)
	install -m 0755 -d $(DESTDIR)$(libdir)
	install -m 0755 $(TARGET) $(DESTDIR)$(libdir)
	ldconfig

# 5. Uninstall library
uninstall:
	$(RM) -f $(DESTDIR)$(includedir)/ultrasonic_communication.h
	$(RM) -f $(DESTDIR)$(includedir)/ultrasonic_transmitter.h
	$(RM) -f $(DESTDIR)$(includedir)/ultrasonic_receiver.h
	$(RM) -f $(DESTDIR)$(libdir)/$(TARGET)
	ldconfig

# Include the dependencies
-include $(DEP)